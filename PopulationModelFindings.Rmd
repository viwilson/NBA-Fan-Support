---
title: "Predicting NBA Fan Support by Population Size"
output: html_notebook
---

```{r}
popsize_model <- lm(Popularity ~ Size + factor(MonthNum):(W.L. + Playoffs)
                       ,na.action = na.exclude, data = NBATeams)
summary(popsize_model)

NBATeams <- NBATeams %>% add_predictions(popsize_model, var = "pred_by_pop")
```
We decided to fit a linear model to predict popularity scores for all teams, using TV Market Size, Month, and the interactions between month of the year and Win/Loss percentage and month of the year and Playoff performance (which measures how far a team made it in the playoffs for a given year). We also fit a model that used Team instead of TV market size as a predictor, but we believe that this model is a better fit for a few reasons. When using the model with Team as a predictor, the model was using an average for each particular team in order to fit the predictions. 

```{r}
NBATeams %>%
  filter(Team == "ClevelandCavaliers") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")

NBATeams %>%
  filter(Team == "GoldenStateWarriors") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")
```
In the two plots above, I have plotted Actual vs Predicted Popularity for the Cleveland Cavaliers and the New York Knicks. The predicted popularity for the model using Team as a predictor is shown in red, whereas the predicted popularity for the model using TV Market Size as a predictor is shown in green. The line in black represents the observed popularity score. We can see that using team as a predictor in the model is pulling the average popularity scores up, so the results are a bit more inaccurate when using this model due to this. Thus, we proceed with using the model with the predictor of TV Market Size in our analysis.

One issue that we had to correct for with this model is the fact that there are 2 teams that share a TV Market. The Los Angeles Lakers and Clippers share a market (as well as an arena), and the Brooklyn Nets and New York Knicks share a TV market as well. In order to quantify each of these 4 team's respective market share, I referred to the Nielsen Ratings for these teams. 

From the data available at https://www.sportsbusinessdaily.com/Journal/Issues/2019/02/18/Media/NBA-ratings.aspx I used the average rating for each of these 4 teams. The Lakers had an average rating of 2.59 and the Lakers had an average rating of 0.53. In order to calculate the market share percentage, I summed these two values and then divided each by the sum (eg: 2.59/(0.53 + 2.59) = 0.8725 for LA Lakers). Once all of these percentages were obtained, I multiplied the team's original TV Market Size value by this percentage to obtain their adjusted market size value.

```{r}
Summerpops <- NBATeams %>% 
  group_by(Team) %>%
  filter(!is.na(Popularity)) %>% 
  filter(!is.na(pred_by_pop)) %>% 
  filter(Date %within% interval("2004-7-01", "2018-10-01")) %>%
  summarize(SummerPopDiff = mean(Popularity - pred_by_pop))

t.test(Summerpops$SummerPopDiff)
```

```{r}
NBATeams %>%
  group_by(factor(Team)) %>%
  summarise_at(vars(BWScore), funs(mean(., na.rm=TRUE)))

NBATeams %>%
  group_by(Season) %>%
  group_by(Team) %>%
  mutate(teststat = Popularity - pred_by_pop) 
```

