---
title: "Predicting NBA Fan Support by Population Size"
output: html_notebook
---

```{r, echo = FALSE}
knitr::opts_chunk$set(error = TRUE)
library(readr)
#Reading in dataset
#NBARel <- read.csv("/Users/Victor/Desktop/Senior Project/RelativeNBATrends.csv", header = TRUE)
NBARel <- read.csv("./RelativeNBATrends.csv", header = TRUE)
NBA_Team_Records <- read_csv("./NBA_Team_Records.csv")

#Reshaping data from wide format to long format
library(tidyverse)
library(lubridate)
NBATeams <- gather(NBARel, Team, Popularity, AtlantaHawks:WashingtonWizards, factor_key=TRUE)
names(NBATeams)[1] <- "Date"

#Creating new variable indicating month of year for each observation
# MonthNum2 <- substr(as.character(NBATeams$Month), 6,7)
# NBATeams$MonthNum <- MonthNum2

# Make Month a datetime object
NBATeams$Date <- parse_date_time(NBATeams$Date, orders = "ym")
NBATeams$MonthNum <- month(NBATeams$Date)

#Replacing all instances of Popularity scores of "<1" with 0
NBATeams$Popularity<- str_replace(NBATeams$Popularity, "<1","0")

#Setting Popularity variable to be numeric
NBATeams$Popularity <- as.numeric(NBATeams$Popularity)
#Replacing Population Size of Los Angeles Clippers to account for shared market
NBATeams$Size <- ifelse(NBATeams$Team =="LosAngelesClippers", NBATeams$Size*0.1725, NBATeams$Size)

#Replacing Population Size of Los Angeles Lakers to account for shared market
NBATeams$Size <- ifelse(NBATeams$Team =="LosAngelesLakers", NBATeams$Size*0.8725, NBATeams$Size)

#Replacing Population Size of Brooklyn Nets to account for shared market
NBATeams$Size <- ifelse(NBATeams$Team =="BrooklynNets", NBATeams$Size*0.3072, NBATeams$Size)

#Replacing Population Size of New York Knicks to account for shared market
NBATeams$Size <- ifelse(NBATeams$Team =="NewYorkKnicks", NBATeams$Size*0.6928, NBATeams$Size)

basic_model <- lm(Popularity ~ factor(MonthNum) + Team, data = NBATeams)

summary(basic_model)

library(modelr)
NBATeams <- NBATeams %>% add_predictions(basic_model)

NBATeams <- NBATeams %>% mutate(
  Season = case_when(
    month(Date) >= 10 & day(Date) > 15 ~ year(Date),  ## nuance cutoff
    TRUE ~ year(Date) - 1
  )
)

#Setting Season variable to be character instead of numeric
NBATeams$Season <- as.character(NBATeams$Season)


##Region/Market for each team ()


#Merging dataset with another dataset containing team record, playoffs, etc.
NBATeams <- left_join(NBATeams, NBA_Team_Records, by = c("Season", "Team")) 


names(NBATeams)[10] <- "W.L."

#NBATeams <- read_csv("./NBATeams_Cleaned.csv")

```


```{r}
popsize_model <- lm(Popularity ~ Size + factor(MonthNum):(W.L. + Playoffs)
                       ,na.action = na.exclude, data = NBATeams)
summary(popsize_model)

NBATeams <- NBATeams %>% add_predictions(popsize_model, var = "pred_by_pop")
```
We decided to fit a linear model to predict popularity scores for all teams, using TV Market Size, Month, and the interactions between month of the year and Win/Loss percentage and month of the year and Playoff performance (which measures how far a team made it in the playoffs for a given year). We also fit a model that used Team instead of TV market size as a predictor, but we believe that this model is a better fit for a few reasons. When using the model with Team as a predictor, the model was using an average for each particular team in order to fit the predictions. 

```{r}
NBATeams %>%
  filter(Team == "ClevelandCavaliers") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")

NBATeams %>%
  filter(Team == "GoldenStateWarriors") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")
```
In the two plots above, I have plotted Actual vs Predicted Popularity for the Cleveland Cavaliers and the New York Knicks. The predicted popularity for the model using Team as a predictor is shown in red, whereas the predicted popularity for the model using TV Market Size as a predictor is shown in green. The line in black represents the observed popularity score. We can see that using team as a predictor in the model is pulling the average popularity scores up, so the results are a bit more inaccurate when using this model due to this. Thus, we proceed with using the model with the predictor of TV Market Size in our analysis.

One issue that we had to correct for with this model is the fact that there are 2 teams that share a TV Market. The Los Angeles Lakers and Clippers share a market (as well as an arena), and the Brooklyn Nets and New York Knicks share a TV market as well. In order to quantify each of these 4 team's respective market share, I referred to the Nielsen Ratings for these teams. 

```{r}
NBATeams %>%
  filter(Team == "BrooklynNets") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")

NBATeams %>%
  filter(Team == "NewYorkKnicks") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")
```

From the data available at https://www.sportsbusinessdaily.com/Journal/Issues/2019/02/18/Media/NBA-ratings.aspx I used the average rating for each of these 4 teams. The Lakers had an average rating of 2.59 and the Lakers had an average rating of 0.53. In order to calculate the market share percentage, I summed these two values and then divided each by the sum (eg: 2.59/(0.53 + 2.59) = 0.8725 for LA Lakers). Once all of these percentages were obtained, I multiplied the team's original TV Market Size value by this percentage to obtain their adjusted market size value.

```{r}
Summerpops <- NBATeams %>% 
  group_by(Team) %>%
  filter(!is.na(Popularity)) %>% 
  filter(!is.na(pred_by_pop)) %>% 
  filter(month(Date) < 10 &  month(Date) > 6) %>%
  summarize(SummerPopDiff = mean(Popularity - pred_by_pop))

t.test(Summerpops$SummerPopDiff)

NBATeams %>% 
  filter(!is.na(Popularity)) %>% 
  filter(!is.na(pred_by_pop)) %>% 
  filter(month(Date) < 10 &  month(Date) > 6) %>%
  mutate(diff = Popularity - pred_by_pop) %>%
  ggplot(aes(x = Team, y = diff)) + geom_boxplot()
```


```{r}

NBATeams %>%
  filter(Team == c("ClevelandCavaliers", "LosAngelesLakers", "MiamiHeat")) %>%
  ggplot(aes(x = Date, y = Popularity/pred_by_pop, color = Team)) + geom_line()
```

## negative predictions to 0

## make final dataset that reads in properly

## side by side to justify Nielsen adjustment

```{r}
#Changing predicted values that are below 0 to be zero
NBATeams$pred_by_pop <- ifelse(NBATeams$pred_by_pop < 0, 0, NBATeams$pred_by_pop)


```


```{r}

NBATeams %>%
  filter(Succ_Cat == "Dark Horse")
  group_by(Season) %>%
  group_by(Team) %>%
  filter(Succ_Cat == "Dark Horse")
  mutate(DHteststat = Popularity - pred_by_pop) 

  
#Differences in Ratios for Dark Horses
bwpop_DarkHorse <- NBATeams %>% filter(Succ_Cat == "Dark Horse") %>%
group_by(Team) %>% 
summarize(DarkHorseDiff = mean(Popularity, na.rm = TRUE)/mean(pred_by_pop, na.rm = TRUE)) %>%
arrange(DarkHorseDiff)
bwpop_DarkHorse

#Differences in Ratios for Contenders
bwpop_Contender <- NBATeams %>% filter(Succ_Cat == "Contender") %>%
group_by(Team) %>% 
summarize(ContenderDiff = mean(Popularity, na.rm = TRUE)/mean(pred_by_pop, na.rm = TRUE)) %>%
arrange(ContenderDiff)
bwpop_Contender

#Differences in Ratios for Favorites
bwpop_Favorite <- NBATeams %>% filter(Succ_Cat == "Heavy Favorite") %>%
group_by(Team) %>% 
summarize(FavoriteDiff = mean(Popularity, na.rm = TRUE)/mean(pred_by_pop, na.rm = TRUE)) %>%
arrange(FavoriteDiff)
bwpop_Favorite

#Joining Datasets
BW_Ratio <- bwpop_DarkHorse %>% left_join(bwpop_Contender)

#JoiningDatasets
BW_Ratio <- BW_Ratio %>% left_join(bwpop_Favorite)

#Changing NA's to be 0 in order to compute differences
BW_Ratio[is.na(BW_Ratio)] <- 0

BW_Ratio$BWScoreRatio <- BW_Ratio$FavoriteDiff + BW_Ratio$ContenderDiff - BW_Ratio$DarkHorseDiff

BW_Ratio %>% arrange(-BWScoreRatio)



```

```{r}
ggplot(BW_Ratio, aes(x = Team, y = BWScoreRatio, fill = Team)) + geom_point() + theme(axis.text.x=element_text(angle=45, hjust=1)) + 
  guides(fill = FALSE)
  
```


```{r}
library(gganimate)
library(gifski)
library(png)
theme_set(theme_bw())

p <- NBATeams %>%
  filter(Team == c("ClevelandCavaliers", "LosAngelesLakers", "MiamiHeat")) %>%
  ggplot(aes(x = Date, y = Popularity, color = Team)) + geom_line() + ylim(0,100)

p + transition_reveal(Date)

```


```{r}
#Nielsen Adjustment Brooklyn Nets
NBATeams %>%
  filter(Team == "BrooklynNets" & Date %within% interval("2013-01-01", "2018-12-01")) %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")

#Without Nielsen Adjustment
#NBA_Unadj <- read_csv("./NBATeams_Nielsen_Unadj.csv")

NBA_Unadj %>%
  filter(Team == "BrooklynNets" & Date %within% interval("2013-01-01", "2018-12-01")) %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")


```
Here, we are comparing the fits of the predicted popularity scores against the observerd popularity scores for the Brooklyn Nets between 2013 and 2018 (because the Nets relocated to Brooklyn in 2013). The first graph shows the comparison of the predicted values, using the adjusted Nielsen values where Brooklyn is given roughly 30% of the New York Market share (instead of the previous full market share). 

The second plot shows the predicted popularity scores against the observed the popularity scores, without the adjustment for the shared New York City market with the New York Knicks. In this model, we can see that since the Brooklyn Nets are being allotted the entire New York City market share, the model is greatly overpredicting popularity scores for the Nets throughout all time points.

Thus, we proceeded with the corrected Nielsen population size for the Brooklyn Nets, where they are receiving 30% of the New York City market share.

```{r}
NBATeams %>%
  filter(Team == "LosAngelesClippers") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")

#Without Nielsen Adjustment
#NBA_Unadj <- read_csv("./NBATeams_Nielsen_Unadj.csv")

NBA_Unadj %>%
  filter(Team == "LosAngelesClippers") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")
```
We also see similar results when viewing the predicted popularity scores for the Los Angeles Clippers. After adjusting the Nielsen population size, we see that the model is also no longer overpredicting the popularity scores for the Clippers. 

#Creating Clean Final Datset
```{r}
names(NBATeams)

#Deleting columns that are not used
NBATeams <- NBATeams[, -c(7,12,13,14,15,16,17,18,20)]

write.csv(NBATeams, "./NBATeams_Final.csv")
```

