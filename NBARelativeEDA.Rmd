---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
knitr::opts_chunk$set(error = TRUE)
library(readr)
#Reading in dataset
#NBARel <- read.csv("/Users/Victor/Desktop/Senior Project/RelativeNBATrends.csv", header = TRUE)
NBARel <- read.csv("./RelativeNBATrends.csv", header = TRUE)
NBA_Team_Records <- read_csv("./NBA_Team_Records.csv")

#Reshaping data from wide format to long format
library(tidyverse)
library(lubridate)
NBATeams <- gather(NBARel, Team, Popularity, AtlantaHawks:WashingtonWizards, factor_key=TRUE)
names(NBATeams)[1] <- "Date"

#Creating new variable indicating month of year for each observation
# MonthNum2 <- substr(as.character(NBATeams$Month), 6,7)
# NBATeams$MonthNum <- MonthNum2

# Make Month a datetime object
NBATeams$Date <- parse_date_time(NBATeams$Date, orders = "ym")
NBATeams$MonthNum <- month(NBATeams$Date)

#Replacing all instances of Popularity scores of "<1" with 0
NBATeams$Popularity<- str_replace(NBATeams$Popularity, "<1","0")

#Setting Popularity variable to be numeric
NBATeams$Popularity <- as.numeric(NBATeams$Popularity)

```


```{r}
#Calculating mean for each NBA team
aggregate(Popularity ~ Team, NBATeams, mean) %>% arrange(desc(Popularity))
```
From viewing the mean popuarlity score for each team, we see that the teams with
the highest average popularity scores since 2004 are the Los Angeles Lakers,
Golden State Warriors, and Cleveland Cavaliers. This makes intuitive sense 
because the Lakers are consistently one of the most popular teams in the league
and have one of the largest fanbases. The Cleveland Cavaliers and Golden State Warriors have also been very succesful teams lately, having played each other
in the NBA Finals the past 4 years, from 2015-2018. 

```{r}
#Boxplot of Popularity score by each month
ggplot(NBATeams, aes(group = month(Date), y = log(Popularity))) + geom_boxplot()
```
Shown above is a boxplot of the log Popularity scores for each month. 



In the boxplot above, we can see that the median Popularity scores for each month are all very similar, although April appears to have a slightly higher median popularity score, which makes sense this is tradtionally the month in which the NBA Playoffs begin. June also appears to have the most outliers and contains the highest Popularity score across all observations, which also makes sense because this typically when the NBA Finals are held, so we expect the two teams that are playing in the Finals to have a very large increase in search traffic which results in a much higher Popularity score .


```{r}
#Scatterplot with mean and median Popularity score by month
#Red = Mean , Blue = Median

NBATeams %>%
  group_by(MonthNum) %>%
  summarize_at(vars(Popularity), funs(mean, median)) %>%
  ggplot() + geom_point(aes(x = MonthNum, y = mean), col = "red") +
  geom_point(aes(x = MonthNum, y = median), col = "blue") 
```
In this plot, the red dots represent the mean popularity score across all 30 
NBA teams for each month, whereas the blue dots represent the median popularity
score. We can see that for each month except for September, the mean Google
Trends search popularity score is lower than the median. This is to be expected,
since the data is skewed to the right, with the few outlying popularity scores
pulling up the mean. This difference between the mean and the median and median
is even more pronounced in the months of April, May, and June. This also makes
sense becauses this is during the NBA Playoff season, and we expect the teams
that make the playoffs to have a large spike in their Popularity score during
the time in which they are competing in the playoffs. 
```{r}
NBATeams %>% 
  filter(Team %in% c("ClevelandCavaliers", "GoldenStateWarriors")) %>%
  ggplot(aes(x = Date, y = Popularity, color = Team)) + geom_line()

NBATeams %>% 
  filter(Date %within% interval("2018-04-01", "2018-06-01")) %>%
  ggplot(aes(x = Date, y = Popularity, color = Team)) + geom_line()

NBATeams %>% 
  filter(Date %within% interval("2004-11-01", "2018-08-01") & Team %in% c("ClevelandCavaliers", "GoldenStateWarriors")) %>%
  ggplot(aes(x = Date, y = Popularity, color = Team)) + geom_line()



NBATeams %>% 
  filter(Date %within% interval("2018-04-01", "2018-07-01")) %>%
  ggplot(aes(x = Date, y = Popularity, color = Team)) + geom_line()
```
In this first plot, we are comparing the popularity scores for the Cleveland
Cavaliers and the Golden State Warriors, across all time points. We can see that the popularity scores for both teams never exceeded about 15 until 2015. In 2015 we see a large increase in the popularity score for the Golden State Warriors.
We also see large spikes in the popularity scores for both teams in what appears to be the middle of the years for 2016, 2017, and 2018. The Cavaliers and the Warriors played each other in the NBA Finals for all 3 of these years, so this is likely the explanation for the large increase in popularity for these teams. 



In this second plot, we are examining the popularity scores for all 30 teams
from April 2018 to June 2018. These dates encompass the duration of the 2018
playoffs, so we are hoping this plot can help give us an idea of what teams 
performed well in the NBA playoffs this year. Here we can see that the ClevelandCavaliers had the highest popularity score for the entirety of the playoffs,with the Golden State Warriors following closely behind. This makes sense again because these two teams ended playing each other in the NBA Finals yet again.

We also see a large cluster of teams near the bottm that have popularity scores that are hardly ever above 10 for these months. These all appear to be teams that did not make the NBA Finals in 2018. Thus, this graph seems to suggest that teams that perform well during the NBA playoffs tend to receive a large increase in search popularity. 

```{r}
basic_model <- lm(Popularity ~ factor(MonthNum) + Team, data = NBATeams)

summary(basic_model)

library(modelr)
NBATeams <- NBATeams %>% add_predictions(basic_model)

NBATeams %>% 
  filter(Team == "HoustonRockets") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red")  + 
  ggtitle("Houston Rockets Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "GoldenStateWarriors") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("GS Warriors Actual vs. Predicted Popularity")


NBATeams %>% 
  filter(Team == "PortlandTrailBlazers") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Portland TrailBlazers Actual vs. Predicted Popularity")


NBATeams %>% 
  filter(Team == "OklahomaCityThunder") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("OKC Thunder Actual vs. Predicted Popularity")


NBATeams %>% 
  filter(Team == "UtahJazz") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("UtahJazz Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "NewOrleansPelicans") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("NO Pelicans Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "SanAntonioSpurs") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("SA Spurs Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "MinnesotaTimberwolves") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Minnesota Timberwolves Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "TorontoRaptors") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Toronto Raptors Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "BostonCeltics") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Boston Celtics Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "Philadelphia76ers") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Philadelphia 76ers Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "ClevelandCavaliers") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Cleveland Cavaliers Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "IndianaPacers") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Indiana Pacers Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "MiamiHeat") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("MiamiHeat Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "MilwaukeeBucks") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Milwaukee Bucks Actual vs. Predicted Popularity")

NBATeams %>% 
  filter(Team == "WashingtonWizards") %>%
  group_by(MonthNum) %>%
  summarize(avg_pop = mean(Popularity), pred = mean(pred)) %>%
  ggplot() + geom_line(aes(x = MonthNum, y = avg_pop)) + geom_line(aes(x = MonthNum, y = pred), col = "red") + 
  ggtitle("Washington Wizards Actual vs. Predicted Popularity")

```
Here, we have fit a very basic linear model that attempts to predict popularityscore, using month of the year and team as predictors. From the resuts of this model, we see that the months of May, June, July, August, September, and Octoberare all significant predictors of popularity score. The coefficients for the months of May and June are both positive, which indicates that these months are associated with an increase in popularity score. This makes sense because the months of May and June are when the NBA Playoffs come to a close, and the NBA Finals typically begin towards the end of May. Contrastly, the months of July, August, September, and October all have negative coefficients, indicating that these months are associated with decreases in popularity score. 

This also makes sense because these months all encompass the NBA offseason, in which no NBA games are played. There is not much going on in the NBA during these times aside from free agency and training camps, so we expect a decrease in search popularity throughout the NBA during these months. 


I have also plotted the popularity scores aross the months of the year for all 16 teams that made the NBA Playoffs in 2018. I then overlaid a line in red for each NBA team, which represents the predicted popularity scores throughout the months of year. My hope is that comparing the predicted popularity scores to the actual probability scores with the teams that made the playoffs would allow me to see how this model is performing in terms of predicting popularity score during the months in which the playoffs occur. 

After examining all 16 of the plots above, we can see that the model does have some difficulty in predicting the popularity scores for teams that do end up making the playoffs. For the months of May and June, there is a large distance between the actual and predicted popularity scores for nearly all of these 16 teams. The model is faily inconsistent as well, as it overpredicts popularity scores during these months for nearly half of the teams, and underpredicts popularity scores during these months for the other half of the teams. This indicates that we perhaps need to include another variable in our model that measures performance during the regular season or performance in the playoffs.


```{r}
# basic_model <- lm(Popularity ~  Team + factor(MonthNum):(Made.Playoffs + Record + Finish + Round.of.Playoffs), data = NBATeams)
```


```{r}

#Obtaining first 4 characters of Season String to match with other dataset
SeasonYear <- substr(as.character(NBA_Team_Records$Season), 1,4)
NBA_Team_Records$Season <- SeasonYear


#Removing all asterisks from the end of team names
NBA_Team_Records$Team <- gsub("[*].*$","",NBA_Team_Records$Team)

#Removing whitespaces from Team Names to match format of other dataset
NBA_Team_Records$Team <- gsub(" ","",NBA_Team_Records$Team) 
```




```{r}
NBATeams <- NBATeams %>% mutate(
  Season = case_when(
    month(Date) >= 10 & day(Date) > 15 ~ year(Date),  ## nuance cutoff
    TRUE ~ year(Date) - 1
  )
)

#Setting Season variable to be character instead of numeric
NBATeams$Season <- as.character(NBATeams$Season)


##Region/Market for each team ()


#Merging dataset with another dataset containing team record, playoffs, etc.
NBATeams <- left_join(NBATeams, NBA_Team_Records, by = c("Season", "Team")) 


names(NBATeams)[10] <- "W.L."

```

```{r}
seasondata_model <- lm(Popularity ~ Team + factor(MonthNum):(W.L. + Playoffs)
                       , data = NBATeams)
summary(seasondata_model)
```


```{r}
#Viewing mean Win/Loss percentages since 2004
aggregate(W.L. ~ Team, NBATeams, mean) %>% arrange(desc(W.L.))

aggregate(Popularity ~ Team, NBATeams, mean) %>% arrange(desc(Popularity))
```
Upon viewing the mean win percentages for each team, we see that the teams
with the highest win percentages since 2004 are the San Antonio Spurs, the 
Oklahoma City Thunder, and the Dallas Mavericks. Meanwhile the teams with the 
lowest win percentages are the Minnesota Timberwolves, the Philadelphia 76ers,
and the Sacramento Kings. 

When comparing the win percentages and the popularity scores for each team,
we can see that there is somewhat of an association between win percentage and 
search popularity. The teams with the top 3 win percentages since 2004 which are
the San Antonio Spurs, the Oklahoma City Thunder, and the Dallas Mavericks, are
also within the top 11 for mean popularity score. This may seem to indicate that
teams that have higher win percentages are likely to have higher popularity
scores. 

```{r}
## Need to combine observations like "made semis"
## Blanks -> No, did not make semis

NBATeams <- NBATeams %>% add_predictions(seasondata_model)

NBATeams %>%
  filter(Team == "HoustonRockets") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") +
  ggtitle("Actual vs. Predicted Popularity")
```

```{r}
## KB - mixed
```

```{r}
#Setting all blank values of Playoffs variable to be of type N/A
is.na(NBATeams$Playoffs) <- which(NBATeams$Playoffs == "")

#Setting all N/A observations of Playoffs variable to read as "Did Not Make #Playoffs"
NBATeams$Playoffs[is.na(NBATeams$Playoffs)] <- "Did Not Make Playoffs"

#Renaming Playoffs values to combine East/West
NBATeams$Playoffs<- as.character(NBATeams$Playoffs)

#Renaming Western Conference Finals
NBATeams$Playoffs[NBATeams$Playoffs == "Lost W. Conf. Finals"] <- "Lost Conf. Finals"

#Renaming Eastern Conference Finals
NBATeams$Playoffs[NBATeams$Playoffs == "Lost E. Conf. Finals"] <- "Lost Conf. Finals"

#Renaming Eastern Conference Semis
NBATeams$Playoffs[NBATeams$Playoffs == "Lost E. Conf. Semis"] <- "Lost Conf. Semis"

#Renaming Western Conference Semis
NBATeams$Playoffs[NBATeams$Playoffs == "Lost W. Conf. Semis"] <- "Lost Conf. Semis"

#Renaming Eastern Conference 1st Round
NBATeams$Playoffs[NBATeams$Playoffs == "Lost E. Conf. 1st Rnd."] <- "Lost 1st Round"

#Renaming Western Conference 1st Round
NBATeams$Playoffs[NBATeams$Playoffs == "Lost W. Conf. 1st Rnd."] <- "Lost 1st Round"

#Setting Playoffs variable to be a factor again
NBATeams$Playoffs <- as.factor(NBATeams$Playoffs)

#Checking levels of Playoff variable to ensure only 6 possible levels
levels(NBATeams$Playoffs)

```

```{r}
seasondata_model <- lm(Popularity ~ Team + factor(MonthNum):(W.L. + Playoffs)
                       , data = NBATeams)
summary(seasondata_model)

NBATeams <- NBATeams %>% add_predictions(seasondata_model)

NBATeams %>%
  filter(Team == "NewYorkKnicks") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") +
  ggtitle("Actual vs. Predicted Popularity")
```

## Bandwagony

```{r}


NBATeams %>%
  filter(Team == "GoldenStateWarriors") %>%
  dplyr::select(Playoffs, pred, Popularity, W.L., MonthNum) %>%
  group_by(Playoffs) %>%
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE))

NBATeams %>%
  filter(Team == "NewYorkKnicks") %>%
  dplyr::select(pred, Popularity, W.L.) %>%
  group_by(W.L.) %>%
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE)) %>%
  ggplot(aes(x = W.L., y = Bandwagon)) + geom_point() + stat_smooth(method = "lm")
```

- most to least bandwagony teams
- data from regions specifically, balance by TV market size?
- nice plots by Victor
- Market size/TV market into data, explore at will


```{r}
#Reading in NBA Market Dataset obtained from #https://www.sportsmediawatch.com/nba-market-size-nfl-mlb-nhl-nielsen-ratings/

NBAMarket <- read.csv("NBAMarketSize.csv", header = TRUE)
#Contains data on television market size, as defined by Nielsen market size.
```
Note: Toronto is not included in this dataset since Nielsen only tracks data
for cities in the United States. Need to decide how to account for this, since our data from Google Trends only includes searches in the United States, but
the Raptors play in Toronto. Include them with New York??



```{r}
NBATeams %>%
  dplyr::select(Playoffs, pred, Popularity, W.L., MonthNum, Team) %>%
  group_by(Team, Playoffs == "Did Not Make Playoffs") %>%
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE)) #%>% arrange(-Bandwagon)
```
The teams that have the highest "Bandwagon" values according to our
metric, are the Los Angeles Lakers, Golden State Warriors, Philadelphia 76ers,
Boston Celtics, and Milwaukee Bucks. This seems to make intiuitive sense because
the Lakers and the Warriors are teams that are typically accused of having the
most "bandwagon" fans. Contrastly, the teams that have the lowest "Bandwagon"
values are the Oklahoma City Thunder, New Orleans Pelicans, and Brooklyn Nets.
It is interesting to note that these teams have all recently relocated or have
rebranded the name of their team. These teams are likely all near the bottom 
of the bandwagon rankings since we do not have much data on these data for the
model, so the model likely struggles in creating an accurate prediciton for their search popularity. 

```{r}
bw <- NBATeams %>%
  dplyr::select(Playoffs, pred, Popularity, W.L., MonthNum, Team) %>%
  group_by(Team, Playoffs) %>%
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE)) 

bw %>% filter(Team == "GoldenStateWarriors") %>%
  ggplot(aes(x = Playoffs, y = Bandwagon)) + geom_col()

NBATeams %>%
  dplyr::select(Playoffs, pred, Popularity, W.L., MonthNum, Team, Season) %>%
  group_by(Season, Team) %>%
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE),
            W.L. = mean(W.L.)) %>%
  filter(Team == "BostonCeltics") %>%
  ggplot(aes(x = W.L., y = Bandwagon)) + geom_point()
```

```{r}
NBATeams %>% filter(Playoffs != "Did Not Make Playoffs") %>%
  group_by(Team, Season) %>% 
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE)) %>%
  ggplot(aes(x = Season, y = Bandwagon, col = Team)) +
  geom_point()
```

```{r}
NBATeams %>% 
  filter(Playoffs == "Did Not Make Playoffs") %>%
  group_by(Team, Season) %>% 
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE)) %>%
  ggplot(aes(x = Season, y = Bandwagon, col = Team)) +
  geom_point()
```

```{r}
#Computing Bandwagon Score for years in which team did not make pos
NBATeams %>% filter(Playoffs == "Did Not Make Playoffs") %>%
  group_by(Team) %>% 
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE))


NBATeams %>% 
  group_by(Team, Season) %>% 
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE)) %>%
  filter(Team == "LosAngelesClippers") %>%
  ggplot(aes(x = Season, y = Bandwagon)) + geom_point()

```
```{r}
#Computing Bandwagon Score for years in which team made playoffs
bw_Playoffs <- NBATeams %>% filter(Playoffs != "Did Not Make Playoffs") %>%
  group_by(Team) %>% 
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE))
```

```{r}
#Computing Bandwagon Score for years in which team did not make playoffs
bw_NoPlayoffs <- NBATeams %>% filter(Playoffs == "Did Not Make Playoffs") %>%
  group_by(Team) %>% 
  summarize(Bandwagon = mean(Popularity, na.rm = TRUE) - mean(pred, na.rm = TRUE))
```


```{r}
bw_Overall<- bw_NoPlayoffs %>% dplyr::select(Team)
bw_Overall$Playoffs <- bw_Playoffs$Bandwagon
bw_Overall$NoPlayoffs <- bw_NoPlayoffs$Bandwagon
bw_Overall$Bandwagon <- bw_Overall$Playoffs - bw_Overall$NoPlayoffs

bw_Overall %>% arrange(desc(Bandwagon))
```
* statistical tests for pop. disc.  differences for:
- PO vs not
- W.L.
- more categories - didn't make POs vs. 1st round etc

* Bandwagon metrics correlate to:
- overall popularity of team
- overall success of team
- other confounders

* Incorporating other datasets


```{r}
#Testing differences of Popularity scores across Playoff categories
PlayoffsAnova <- lm(Popularity~Playoffs, data=NBATeams)
anova(PlayoffsAnova)

aov.fit1 <- aov(Popularity ~ Playoffs, data=NBATeams)
posthoc <- TukeyHSD(x=aov.fit1, conf.level=0.95)
posthoc

ggplot(NBATeams, aes(y = log(Popularity), x = Playoffs, fill = Playoffs)) + geom_boxplot()


```


```{r}
#Creating new indicator variable for if team made playoffs
NBATeams <- mutate(NBATeams, IndPlayoffs = ifelse(Playoffs == "Did Not Make Playoffs", "No Playoffs", "Playoffs"))

POIndAov <- lm(Popularity~Playoffs, data=NBATeams)
anova(POIndAov)

TukeyHSD(aov(POIndAov))
```


* statistical tests for pop. disc.  differences for:
- PO vs not
- W.L.
- more categories - didn't make POs vs. 1st round etc

* Bandwagon metrics correlate to:
- overall popularity of team
- overall success of team
- other confounders

* Incorporating other datasets

```{r}
names(bw_Overall) <- c("Team", "PO_diff", "NP_diff", "Bandwagon")

NBATeams <- NBATeams %>% left_join(bw_Overall)

ggplot(NBATeams, aes(x = Team, y = Bandwagon, fill = Team)) + geom_col()
```

## 3 success categories

## medians

why are medians so different than means for some teams?
which do you think is better measure, why?
can you make hypothesis test conclusions?

```{r}
NBATeams %>% filter(Playoffs != "Did Not Make Playoffs") %>%
  mutate(
    diff = Popularity - pred,
  ) %>%
  group_by(Team) %>% 
  summarize(
    Bandwagon2 = median(diff, na.rm = TRUE)) %>%
  arrange(Bandwagon2)

NBATeams %>% filter(Playoffs == "Did Not Make Playoffs") %>%
  mutate(
    diff = Popularity - pred,
  ) %>%
  group_by(Team) %>% 
  summarize(
    Bandwagon2 = median(diff, na.rm = TRUE)) %>%
  arrange(Bandwagon2)
```


## market size

```{r}
NBAMarketSize <- read.csv("NBAMarketSize.csv")

NBAMarketSize <- NBAMarketSize %>% mutate(
  Size = as.numeric(unlist(str_remove_all(Size, fixed(","))))
)

NBATeams <- NBATeams %>% left_join(NBAMarketSize)
```

- bw and size
- incorporaate size into model

```{r}
popsize_model <- lm(Popularity ~ Size + factor(MonthNum):(W.L. + Playoffs)
                       ,na.action = na.exclude, data = NBATeams)
summary(popsize_model)

NBATeams <- NBATeams %>% add_predictions(popsize_model, var = "pred_by_pop")

NBATeams <- NBATeams %>%
  mutate(
    diff = Popularity - pred,
  )

NBATeams %>%
  filter(Team == "LosAngelesClippers") %>%
  ggplot() + geom_line(aes(x = Date, y = Popularity)) + geom_line(aes(x = Date, y = pred), col = "red") + geom_line(aes(x = Date, y = pred_by_pop), col = "green")+
  ggtitle("Actual vs. Predicted Popularity")

#Viewing Correlation to matrix to try and see what is causing rank deficiency
cor(NBATeams[sapply(NBATeams, is.numeric)], use="complete.obs")
```

```{r}
#Creating new success categories for Dark Horse, Contenders, and Heavy Favorites
NBATeams <- 
   mutate(NBATeams,
        Succ_Cat = recode(Playoffs, "Did Not Make Playoffs" = "Dark Horse",
                            "Lost 1st Round" = "Dark Horse",
                            "Lost Conf. Finals" = "Contender",
                            "Lost Conf. Semis" = "Contender",
                            "Lost Finals" = "Heavy Favorite",
                            "Won Finals" = "Heavy Favorite")
    )
```

```{r}
#Writing Dataset for unadjusted Nielsen scores
write.csv(NBATeams, "./NBATeams_Nielsen_Unadj.csv")
```


```{r}
#Mean Bandwagon score for Dark Horse
bw_DarkHorse <- NBATeams %>% filter(Succ_Cat == "Dark Horse") %>%
  group_by(Team) %>% 
  summarize(DarkHorseDiff = mean(Popularity, na.rm = TRUE) - mean(pred_by_pop, na.rm = TRUE)) %>%
  arrange(DarkHorseDiff)


#Mean Bandwagon score for Contenders
bw_Contender <- NBATeams %>% filter(Succ_Cat == "Contender") %>%
  group_by(Team) %>% 
  summarize(ContendersDiff = mean(Popularity, na.rm = TRUE) - mean(pred_by_pop, na.rm = TRUE)) %>%
  arrange(ContendersDiff)


#Mean Bandwagon score for Heavy Favorites
bw_Favorites <- NBATeams %>% filter(Succ_Cat == "Heavy Favorite") %>%
  group_by(Team) %>% 
  summarize(FavoritesDiff = mean(Popularity, na.rm = TRUE) - mean(pred_by_pop, na.rm = TRUE)) %>%
  arrange(FavoritesDiff)

```



```{r}
#Median Bandwagon Scores for teams that were "Dark Horse"
NBATeams %>% filter(Succ_Cat == "Dark Horse") %>%
  mutate(
    diff = Popularity - pred,
  ) %>%
  group_by(Team) %>% 
  summarize(
    BandwagonCats = median(diff, na.rm = TRUE)) %>%
  arrange(BandwagonCats)

#Median Bandwagon Scores for teams that were title contenders
NBATeams %>% filter(Succ_Cat == "Contender") %>%
  mutate(
    diff = Popularity - pred,
  ) %>%
  group_by(Team) %>% 
  summarize(
    Bandwagon2 = median(diff, na.rm = TRUE)) %>%
  arrange(Bandwagon2)

#Median Bandwagon Scores for teams that were heavy favorites
NBATeams %>% filter(Succ_Cat == "Heavy Favorite") %>%
  mutate(
    diff = Popularity - pred,
  ) %>%
  group_by(Team) %>% 
  summarize(
    Bandwagon2 = median(diff, na.rm = TRUE)) %>%
  arrange(Bandwagon2)
```
Here, we see that when teams do not perform very well (either do not make playoffs or lose in the first round of the playoffs), the teams that have much lower median Popularity scores than predicted are the Golden State Warriors and Cleveland Cavaliers. This may indicate some evidence of bandwagon fans, as this means that these two teams are much less popular when they are not performing well. 

Conversely, we see that when performing very well (either losing the NBA Finals or winning the NBA Finals), the teams that have much higher median popularity scores than predicted are once again, the Golden State Warriors and Cleveland Cavaliers. 

From these two statistics, we can see that when the Golden State Warriors and Cleveland Cavaliers perform poorly, they are much less popular than is to be expected, whereas when they perform very well, they are much more popular than is to be expected. Thus, these teams seem to indicate that they suffer from somewhat of a "bandwagon effect".

## bandwagony by year

Statistical conclusion about 1-3 teams and 
* change over time
* significant bandwagonyness
* other?

### fix LA and NY

### average yearly cycle summary plots


```{r}
bw_Cats <- bw_DarkHorse %>% left_join(bw_Favorites)

bw_Cats <- bw_Cats %>% left_join(bw_Contender)

#Replacing all NA's with 0's (to be able to compute differences)
bw_Cats[is.na(bw_Cats)] <- 0

bw_Cats$BWScore <- bw_Cats$FavoritesDiff + bw_Cats$ContendersDiff - bw_Cats$DarkHorseDiff

bw_Cats %>% arrange(-BWScore)

sd1 <- sd(bw_Cats$DarkHorseDiff)

bw_Cats$DH_zscore <- bw_Cats$DarkHorseDiff/sd1
```
For each category of Dark Horse, Contenders, and Favorites, I computed the difference between the mean observed popularity score and mean predicted popularity from our model, for each NBA Team. I then used these 3 values to create a Bandwagon measure for each team. I added the values for Favorites and Contenders for each team, and then subtracted the value for Dark Horse. I used this formula because an indicator of the "Bandwagon effect" would be being more popular than predicted when they are performing well (Favorites or Contenders), and less popular than predicted when they are not performing well (Dark Horse). Thus, using this equation, larger values indicate teams that are more likely to experience the Bandwagon effect, while smaller values indicate that are more loyal or have less of a bandwagon effect. 

From viewing the results of this, we see that the Warriors have by far the largest Bandwagon score, with a value of 12.63. The Cleveland Cavaliers have the next largest Bandwagon score, of 2.71. The teams with the lowest Bandwagon scores are the Orlando Magic, Dallas Mavericks, and Detroit Pistons, who have Bandwagon scores of -8.63, -6.79, and -6.52 respectively. 

```{r}
names(bw_Cats) <- c("Team", "DarkHorseDiff", "FavoriteDiff", "ContenderDiff", "BWScore")

bw_Cats <- bw_Cats[, -6]

NBATeams <- NBATeams %>% left_join(bw_Cats)

ggplot(NBATeams, aes(x = Team, y = BWScore, fill = Team)) + geom_point() + theme(axis.text.x=element_text(angle=45, hjust=1)) + 
  guides(fill = FALSE)
```



```{r}
bwscore.aov <- aov(BWScore ~ Team, data = NBATeams)
summary(bwscore.aov)

model.tables(bwscore.aov,"means",digits=3)


test <- NBATeams %>% 
  group_by(Team, BWScore) %>% 
  mutate(z_score = (BWScore - mean(BWScore, na.rm = TRUE)) / sd(BWScore, na.rm = TRUE))


test %>% group_by(Team) %>% summarize(mean = mean(z_score), sd = sd(z_score)) 
```



```{r}
#Viewing how popularity scores for Warriors change over time
gsw.query <- filter(NBATeams, Team=="GoldenStateWarriors")
gsw.lm <- lm(diff~Season, data= gsw.query)
summary(gsw.lm)
```
Here, we see that for the Golden State Warriors, the seasons that are significantly associated with popularity score are 2014, 2015, 2016, 2017 and 
2018. The coefficients for these years are all also rather large, which indicates that the Warriors experienced a large increase in popularity during these years. 

```{r}
#Viewing how Popularity Scores for Cavaliers change over time
cavs.query <- filter(NBATeams, Team=="ClevelandCavaliers")
cavs.lm <- lm(Popularity~Season, data= cavs.query)
summary(cavs.lm)
```
Here, we see that essentially exactly the same trend for the Cavaliers as we saw for the Warriors. Again, the seasons that are significantly associated with popularity score are 2014, 2015, 2016, 2017 and 2018. The coefficients for these years are all also rather large, which indicates that the Cavaliers also experienced a large increase in popularity during these years. 


## New rmd: using population rather than average: why?  and shared issue


```{r}
NBATeams %>%
  mutate(
    diff = Popularity - pred,
  ) %>%
  filter(Team == "LosAngelesLakers") %>%
  ggplot(aes(x = Date, y = diff)) + geom_line()
```


Summer
Reg Season
Playoffs - participant
Playoffs - out


## Summers for each team = 25 samples.  Evidence of difference from 0?

Wish: 
- Overall bandwagon score for a year
- Bandwagon behavior vs: phase of season? team success?
- (think about regression on residuals)

```{r}
resid_model <- lm(diff ~ Playoffs, data = NBATeams %>% filter(Team == "GoldenStateWarriors"))
summary(resid_model)
```

## reference factor???



```{r}
#Replacing Population Size of Los Angeles Clippers to account for shared market
NBATeams$Size <- ifelse(NBATeams$Team =="LosAngelesClippers", NBATeams$Size*0.1725, NBATeams$Size)

#Replacing Population Size of Los Angeles Lakers to account for shared market
NBATeams$Size <- ifelse(NBATeams$Team =="LosAngelesLakers", NBATeams$Size*0.8725, NBATeams$Size)

#Replacing Population Size of Brooklyn Nets to account for shared market
NBATeams$Size <- ifelse(NBATeams$Team =="BrooklynNets", NBATeams$Size*0.3072, NBATeams$Size)

#Replacing Population Size of New York Knicks to account for shared market
NBATeams$Size <- ifelse(NBATeams$Team =="NewYorkKnicks", NBATeams$Size*0.6928, NBATeams$Size)
```

Here, we are correcting for the the fact the Lakers and Clippers, as well as the Nets and Knicks share a TV market. In order to quantify each of these 4 team's respective market share, I referred to the Nielsen Ratings. From the data available at https://www.sportsbusinessdaily.com/Journal/Issues/2019/02/18/Media/NBA-ratings.aspx I used the average rating for each of these 4 teams. The Lakers had an average rating of 2.59 and the Lakers had an average rating of 0.53. In order to calculate the market share percentage, I summed these two values and then divided each by the sum (eg: 2.59/(0.53 + 2.59)= 0.8725 for LA Lakers). Once all of these percentages were obtained, I multiplied the team's TV Market Size value by this percentage. 


```{r}
#Rerunning popsize model after adjusting Nielsen ratings
popsize_model <- lm(Popularity ~ Size + factor(MonthNum):(W.L. + Playoffs)
                       ,na.action = na.exclude, data = NBATeams)
summary(popsize_model)

NBATeams <- NBATeams %>% add_predictions(popsize_model, var = "pred_by_pop")
```


```{r}
#write.csv(NBATeams, "./NBATeams_Cleaned.csv")
```

